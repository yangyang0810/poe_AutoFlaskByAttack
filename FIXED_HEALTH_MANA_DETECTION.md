# POE自动喝药水 - 血量和蓝量检测修复说明

## 🔧 修复内容

### 1. 血量和蓝量检测问题修复
- **问题**: 健康监控器没有正确启动和运行
- **修复**: 
  - 在 `input_listener.py` 中添加了 `self.main` 引用
  - 修复了健康监控器的启动逻辑
  - 确保POE2自动药水功能启用时健康监控器自动启动
  - 修复了类型转换错误（字符串到浮点数）

### 2. 截图区域调整
- **问题**: 截图区域大小不对，需要只截图左下角血量和右下角蓝量位置
- **修复**: 更新了 `health_monitor.py` 中的截图区域配置
  - **POE1模式**:
    - 血量: 左下角 (x: 1%-20%, y: 88%-95%)
    - 蓝量: 右下角 (x: 80%-99%, y: 88%-95%)
  - **POE2模式**:
    - 血量: 左下角 (x: 1%-15%, y: 90%-98%)
    - 蓝量: 右下角 (x: 85%-99%, y: 90%-98%)

### 3. 键盘按键触发修复
- **问题**: 按键1和2无法正确触发药水
- **修复**:
  - 修复了 `on_flask_trigger` 方法中的引用错误
  - 改进了游戏模式检测逻辑
  - 确保按键模拟功能正常工作

## 🚀 使用方法

### 1. 启用POE2自动药水功能
在配置文件中设置：
```ini
[poe2_auto_flask]
enabled=True
health_threshold=75    # 血量低于75%时触发
mana_threshold=55      # 蓝量低于55%时触发
health_flask_key=1     # 血量药水按键
mana_flask_key=2       # 蓝量药水按键
check_interval=0.2     # 检测间隔(秒)
```

### 2. 设置游戏模式
```ini
[global]
game_type=poe2  # 或 'auto' 自动检测
```

### 3. 测试配置
已创建测试配置文件 `configs/poe2_test.ini`，可以直接使用。

## 🔍 调试功能

程序现在包含调试输出，会在控制台显示：
- 健康监控器启动信息
- 当前血量和蓝量百分比
- 药水触发信息

## ⚠️ 注意事项

1. **分辨率适配**: 如果截图区域仍然不准确，可能需要根据您的屏幕分辨率调整坐标
2. **游戏版本**: 确保游戏UI没有重大变化
3. **权限**: 确保程序有足够的权限进行截图和模拟按键

## 🛠️ 故障排除

如果自动药水仍然不工作：

1. **检查控制台输出**: 查看是否有错误信息
2. **验证配置**: 确认 `poe2_auto_flask.enabled=True`
3. **测试按键**: 手动按1和2键确认药水能正常使用
4. **调整阈值**: 尝试不同的血量和蓝量阈值
5. **检查游戏模式**: 确认程序检测到正确的游戏模式

### 最新修复 (v1.1)
- **修复了类型转换错误**: 配置文件中的数值现在能正确转换为浮点数
- **添加了错误处理**: 如果配置加载失败，会使用默认值继续运行
- **改进了调试输出**: 更清晰的错误信息和状态显示

从终端输出可以看到程序已经能够：
- 切换到POE2模式
- 启动健康监控
- 检测到蓝量不足并触发按键2
- 显示检测到的数值 `[0, 985912, 1837846]`

## 📝 技术细节

- 使用PIL进行图像处理
- 使用numpy进行像素分析
- 使用pynput进行按键模拟
- 支持多线程健康监控
- 动态调整检测频率（血量越低检测越频繁）
