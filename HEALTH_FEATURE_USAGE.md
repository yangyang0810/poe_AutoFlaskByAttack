# POE自动喝药水 - 血量检测功能使用说明

## 🩸 新增功能概述

在原有的定时自动喝药水功能基础上，新增了基于血量检测的智能药水系统，可以根据角色当前血量自动使用指定的药水。

## 🚀 功能特性

### 1. **智能血量监控**
- 实时检测游戏中角色的血量百分比
- 支持不同分辨率和UI缩放的自动适配
- 动态调整检测频率（血量越低检测越频繁）

### 2. **双重药水系统**
- **普通血量药水**: 当血量低于设定阈值时自动使用
- **紧急药水**: 当血量极低（15%以下）时优先使用

### 3. **优先级管理**
- 紧急药水具有最高优先级
- 血量药水优先于常规定时药水
- 避免同时使用多个药水造成浪费

## 📋 配置说明

### 配置文件结构
```ini
[health]
flask_key0=[1,2,]          # 血量药水按键
flask_time0=[5.0,3.0,]     # 血量药水冷却时间
threshold0=[30,20,]        # 血量阈值百分比

[emergency]
flask_key0=[3,]            # 紧急药水按键
flask_time0=[10.0,]        # 紧急药水冷却时间
```

### UI配置界面
如果集成了血量配置UI，可以通过以下方式设置：

1. **启用血量监控**: 勾选"启用血量监控"复选框
2. **设置血量阈值**: 使用滑块调整默认血量阈值（10%-80%）
3. **配置血量药水**: 
   - 按键：设置药水对应的键盘按键
   - 冷却时间：设置药水的冷却时间（秒）
   - 血量阈值：设置触发该药水的血量百分比
4. **配置紧急药水**: 设置在血量极低时使用的药水

## 🔧 技术实现原理

### 血量检测机制
```python
# 1. 截取游戏血条区域
health_region = get_health_bar_region()
screenshot = ImageGrab.grab(health_region)

# 2. 分析红色像素比例
health_percentage = analyze_red_pixels(screenshot)

# 3. 根据血量触发相应药水
if health_percentage <= emergency_threshold:
    use_emergency_flask()
elif health_percentage <= health_threshold:
    use_health_flask()
```

### 优先级处理
```python
# 处理顺序：
1. 紧急药水 (priority=10, 血量≤15%)
2. 血量药水 (priority=8, 血量≤设定阈值)
3. 常规药水 (priority=5, 定时触发)
```

## ⚙️ 安装和使用

### 1. 安装依赖
```bash
pip install Pillow numpy
```

### 2. 启用血量监控
在配置文件中设置：
```ini
[global]
health_monitor_enabled=True
```

### 3. 配置血量药水
编辑配置文件或使用UI界面设置血量药水的按键、冷却时间和触发阈值。

### 4. 校准血条位置（可选）
如果自动识别血条位置不准确，可以：
- 使用UI中的"校准血条位置"按钮
- 手动调整`health_monitor.py`中的血条坐标

## 🎯 使用建议

### 1. **血量阈值设置**
- **生存流角色**: 设置较高阈值（40-50%）确保安全
- **输出流角色**: 设置适中阈值（25-35%）平衡生存和输出
- **紧急药水**: 建议使用瞬回类药水，冷却时间设置较长避免浪费

### 2. **药水搭配建议**
```
普通血量药水: 生命药剂 (30%血量触发, 5秒冷却)
紧急药水: 神圣生命药剂 (15%血量触发, 10秒冷却)
```

### 3. **性能优化**
- 血量检测会消耗一定CPU资源
- 建议在配置稳定后适当调大检测间隔
- 高血量时系统会自动降低检测频率

## 🔍 故障排除

### 1. **血量检测不准确**
- 检查游戏分辨率和UI缩放设置
- 使用校准功能重新设置血条位置
- 确认血条颜色设置正确（红色像素检测）

### 2. **药水不触发**
- 确认血量监控已启用
- 检查药水冷却时间设置
- 验证按键设置是否正确

### 3. **性能问题**
- 适当增加检测间隔时间
- 关闭不必要的血量药水配置
- 确保游戏窗口处于活动状态

## 📈 未来扩展

该血量检测系统为后续功能提供了基础：

1. **Debuff检测**: 检测特定负面效果并自动使用对应药水
2. **蓝量监控**: 扩展到魔法值监控和自动回蓝
3. **更智能的药水管理**: 根据战斗状态调整药水使用策略
4. **多角色配置**: 为不同职业提供预设的药水方案

## 🛡️ 注意事项

- 该功能仅在POE游戏窗口激活时工作
- 截图功能可能被某些安全软件拦截，请添加信任
- 建议在使用前先进行充分测试，确保配置正确
- 遵守游戏规则，合理使用自动化辅助功能
